<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Lecture Notes</title>
    <style>
        .custom::-webkit-scrollbar-track {
            -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            background-color: #F5F5F5;
        }

        .custom::-webkit-scrollbar {
            width: 12px;
            background-color: #F5F5F5;
        }

        .custom::-webkit-scrollbar-thumb {
            border-radius: 10px;
            -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, .3);
            background-color: #993aec;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans">
    <div
        class="w-1/5 bg-gradient-to-b h-screen fixed from-purple-300 via-purple-400 to-purple-600 p-4 rounded-2xl overflow-y-auto custom">
        <nav>
            <ul class="space-y-4">
                <li><a href="../Home/home.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Home</a>
                </li>
                <li><a href="../course outline/outline.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Course
                        Outline</a></li>
                <li><a href="../course description/resdes.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Course
                        Description</a></li>
                <li><a href="../Copy of lecture notes/notes.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Lecture
                        Notes</a></li>
                <li><a href="../Copy of Question papers/papers.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Question
                        Papers</a></li>
                <li><a href="../Model solution/modelsol.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Model
                        Solutions</a></li>
                <li><a href="../samples/samples.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Samples</a>
                </li>
                <li><a href="../Course log/courselog.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Course
                        Log</a></li>
                <li><a href="../Outcome Assesment/assesment.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Outcome
                        Assessment</a></li>
                <li><a href="../Course folder verfication report/resverf.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Folder
                        Verification</a></li>
                <li id="manage-login-btn"><a href="../Manage logins/managelogin.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Manage
                        Login</a></li>
                        <li><a href="../About us/About.html"
                            class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">About us
                            </a></li>
                <li><a href="./login/login.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Logout</a>
                </li>
            </ul>
        </nav>
    </div>
    <div class="ml-[calc(100vw/5)] flex flex-col items-center py-8 space-y-6">
        <!-- Page Heading -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-purple-700">Lecture Notes</h1>
            <p class="text-gray-600">Manage notes week by week</p>
        </div>
        <div
            class="p-5 text-center flex flex-col items-center justify-center gap-4 bg-purple-100 rounded-lg shadow-md border border-purple-300">
            <h2 class="text-xl font-semibold text-purple-700">Current Session Details</h2>
            <div class="grid grid-cols-2 gap-4 w-full max-w-md text-left">
                <div class="flex items-center space-x-2">
                    <span class="font-bold text-purple-900">Session:</span>
                    <p id="sessionInfo" class="text-gray-700"></p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="font-bold text-purple-900">Teacher:</span>
                    <p id="teacherInfo" class="text-gray-700"></p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="font-bold text-purple-900">Class:</span>
                    <p id="classInfo" class="text-gray-700"></p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="font-bold text-purple-900">Course:</span>
                    <p id="courseInfo" class="text-gray-700"></p>
                </div>
            </div>
        </div>

        <!-- Week Selection -->
        <div>
            <label for="week-select" class="block text-lg font-medium text-gray-700">Select Week</label>
            <select id="week-select"
                class="mt-2 block w-40 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500">
                <option value="" disabled selected>Select Week</option>
                <!-- Options for weeks -->
                <script>
                    for (let i = 1; i <= 16; i++) {
                        document.write(`<option value="${i}">Week ${i}</option>`);
                    }
                </script>
            </select>
        </div>

        <!-- Upload and View Section -->
        <div class="bg-white p-6 rounded-lg shadow-md w-96">
            <h2 id="modalTitle" class="text-2xl font-semibold text-purple-600 mb-4">Week - Lecture Notes</h2>

            <!-- File Upload -->
            <div class="flex flex-col space-y-4">
                <input type="file" id="fileUpload" accept=".pdf" class="hidden">
                <button class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition"
                    id="file-btn">
                    <span id="file-status"></span> PDF
                </button>
                <div id="fileList" class="text-gray-700 space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        const state = {
            selectedWeek: null
        };

        // token starts here
        const token = localStorage.getItem('token');
        if (token) {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const isExpired = payload.exp * 1000 < Date.now();
            const role = payload.role || "";

            if (role === 'teacher') {

                document.getElementById('manage-login-btn').style.display = 'none';
            }

            if (isExpired) {
                alert('Session expired. Please log in again.');
                localStorage.removeItem('token'); // Clear expired token
                window.location.href = '../../../login/login.html'; // Redirect to login
            } else {
                // Verify token validity with backend
                fetch('http://localhost:5000/api/auth/validate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`,
                    },
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error('Invalid token. Please log in again.');
                        }
                        return response.json();
                    })
                    .then((data) => {
                        console.log('Token is valid:', data);
                        document.body.style.display = 'block'; // Show the page after validation
                    })
                    .catch((err) => {
                        alert(err.message);
                        localStorage.removeItem('token'); // Clear invalid token
                        window.location.href = '../../login/login.html'; // Redirect to login
                    });
            }
        } else {
            alert('Access denied. Please log in.');
            window.location.href = '../../login/login.html'; // Redirect if no token
        }

        //token ends here



        async function loadFileStatus() {
            const fileStatus = document.getElementById("file-status");
            fileStatus.innerText = "Week"; // Default status

            try {
                let weekValue;
                const weekSelect = document.getElementById('week-select');
                const fileBtn = document.getElementById("file-btn");
                const inputPDF = document.getElementById("fileUpload");

                // Clear previous event listeners
                const newFileBtn = fileBtn.cloneNode(true);
                fileBtn.replaceWith(newFileBtn);

                // Click event for the button
                newFileBtn.addEventListener("click", () => {
                    if (newFileBtn.dataset.fileUrl) {
                        window.open(newFileBtn.dataset.fileUrl, "_blank");
                    } else {
                        inputPDF.click();
                    }
                });

                inputPDF.addEventListener("change", function (event) {
                    handleFileClick("lecture notes", event);
                });

                weekSelect.addEventListener('change', async (event) => {
                    const fileStatus = document.getElementById("file-status"); // Select fresh DOM element
                    fileStatus.innerText = "Checking..."; // ✅ **Properly updates status**

                    weekValue = event.target.value;
                    state.selectedWeek = weekValue;
                    document.getElementById('modalTitle').textContent = `Week ${weekValue} - Lecture Notes`;

                    const formData = {
                        sessionValue: localStorage.getItem("session"),
                        instructorName: localStorage.getItem("teacher"),
                        className: localStorage.getItem("class"),
                        courseName: localStorage.getItem("course"),
                        doctype: "lecture notes",
                        week: weekValue
                    };

                    try {
                        const response = await fetch('http://localhost:5000/api/teacher/check-document', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData),
                        });

                        if (response.ok) {
                            // ✅ Document found → Show "Open"
                            const data = await response.json();
                            let path = data.document.path.replace(/\\/g, '/');
                            const filePath = `http://localhost:5000/${path}`;

                            setTimeout(() => {
                                fileStatus.innerText = "Open"; // ✅ **Force UI update**
                                newFileBtn.dataset.fileUrl = filePath; // Store URL for button
                            }, 100); // Small delay to ensure update is visible

                            const originalButton = document.getElementById("file-btn")
                            if (originalButton) {
                                let clonedButton = originalButton.cloneNode(true); // Clone button
                                clonedButton.id = "file-btn-2"; // Update the ID

                                let clonedInput = document.getElementById("fileUpload").cloneNode(true); // Clone file input                                
                                clonedInput.id = "fileUpload-2"; // Update input ID
                                // console.log(clonedInput);
                                let clonedStatus = clonedButton.querySelector("#file-status");
                                if (clonedStatus) {
                                    clonedStatus.id = "file-status-2"
                                    clonedStatus.innerText = "Upload"
                                }
                                originalButton.parentNode.appendChild(clonedInput);
                                originalButton.parentNode.appendChild(clonedButton);
                                clonedButton.addEventListener("click", () => {
                                    clonedInput.click();                                    
                                })
                                clonedInput.addEventListener("change", function (event) {
                                    handleFileClick("lecture notes", event)
                                })
                            }
                        } else {
                            // ❌ Document not found → Show "Upload"
                            setTimeout(() => {
                                fileStatus.innerText = "Upload";
                                delete newFileBtn.dataset.fileUrl;

                                // Remove dynamically added nodes if they exist
                                const clonedButton = document.getElementById("file-btn-2");
                                const clonedInput = document.getElementById("fileUpload-2");
                                const clonedStatus = document.getElementById("file-status-2");

                                if (clonedButton) clonedButton.remove();
                                if (clonedInput) clonedInput.remove();
                                if (clonedStatus) clonedStatus.remove();
                            }, 100);
                        }
                    } catch (error) {
                        console.error("Error fetching file:", error);
                        fileStatus.innerText = "Error"; // Show error state
                    }
                });

            } catch (error) {
                console.error('Error fetching file', error);
                fileStatus.innerText = "Error";
                alert('An error occurred while fetching the file.');
            }

            // Update UI with local storage values
            document.getElementById('sessionInfo').textContent = localStorage.getItem('session') || "No session selected";
            document.getElementById('teacherInfo').textContent = localStorage.getItem('teacher') || "No teacher selected";
            document.getElementById('classInfo').textContent = localStorage.getItem('class') || "No class selected";
            document.getElementById('courseInfo').textContent = localStorage.getItem('course') || "No course selected";
        }

        document.addEventListener('DOMContentLoaded', loadFileStatus);


        const handleFileClick = async (type, event) => {
            console.log(event.target); 
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                alert('Please upload a valid PDF file.');
                return;
            }

            if (!state.selectedWeek) {
                alert('Please select a week first.');
                return;
            }

            const courseTitle = localStorage.getItem('course'); // Assume course ID is stored in localStorage
            if (!courseTitle) {
                alert('Course title is missing.');
                return;
            }

            const formData = new FormData();


            formData.append('file', file);
            formData.append('week', state.selectedWeek);
            formData.append('doctype', type);

            try {
                const response = await fetch('http://localhost:5000/api/teacher/document', {
                    method: 'POST',
                    headers: {
                        'session': localStorage.getItem('session'),
                        'teacher': localStorage.getItem('teacher'),
                        'class': localStorage.getItem('class'),
                        'course': localStorage.getItem('course'),
                    },
                    body: formData,
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(`Lecture notes uploaded successfully for Week ${state.selectedWeek}!`);
                } else {
                    const errorData = await response.json();
                    alert(`Failed to upload: ${errorData.message}`);
                }
            } catch (error) {
                console.error('Error uploading lecture notes:', error);
                alert('An error occurred. Please try again.');
            } finally {
                event.target.value = ''; // Reset file input
            }

        }

    </script>
</body>

</html>