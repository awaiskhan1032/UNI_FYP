<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outcomes Assessment Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 12px;
            background-color: #F5F5F5;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            border-radius: 10px;
            background-color: #993aec;
        }

        .sub-items {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <!-- Sidebar -->
    <div
        class="w-1/5 bg-gradient-to-b h-screen fixed from-purple-300 via-purple-400 to-purple-600 p-4 rounded-2xl overflow-y-auto custom-scrollbar">
        <nav>
            <ul class="space-y-4">
                <li><a href="../Home/home.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Home</a>
                </li>
                <li><a href="../course outline/outline.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Course
                        Outline</a></li>
                <li><a href="../course description/resdes.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Course
                        Description</a></li>
                <li><a href="../Copy of lecture notes/notes.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Lecture
                        Notes</a></li>
                <li><a href="../Copy of Question papers/papers.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Question
                        Papers</a></li>
                <li><a href="../Model solution/modelsol.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Model
                        Solutions</a></li>
                <li><a href="../samples/samples.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Samples</a>
                </li>
                <li><a href="../Course log/courselog.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Course
                        Log</a></li>
                <li><a href="../Outcome Assesment/assesment.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Outcome
                        Assessment</a></li>
                <li><a href="../Course folder verfication report/resverf.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Course
                        Folder Verification</a></li>
                <li id="manage-login-btn"><a href="../Manage logins/managelogin.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Manage
                        Login</a></li>
                        <li><a href="../About us/About.html"
                            class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">About us
            </a></li>
                <li><a href="./login/login.html"
                        class="block text-center bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Logout</a>
                </li>
            </ul>
        </nav>
    </div>
        <!-- Main Content -->
        <div class="ml-[calc(100vw/5)] p-8">
            <form id="outcomes-form" class="bg-white p-8 rounded-lg shadow-md">
                <!-- University Logo and Name -->
                <div class="text-center mb-8">
                    <div class="mb-4 flex justify-center">
                        <img src="./assets/Austlogo.png" alt="University Logo" class="w-24 h-24">
                    </div>
                    <h1 class="text-2xl font-bold underline">Abbottabad University of Science & Technology</h1>
                    <h2 class="text-xl">Department of Computer Science</h2>
                </div>

                <!-- Batch and Year -->
                <div class="flex justify-center space-x-4 mb-8">
                    <div>
                        <label class="block mb-2">Batch:</label>
                        <input type="text" id="batch" class="border-b border-black w-24 text-center" readonly>
                    </div>
                    <div>
                        <label class="block mb-2">Year:</label>
                        <input type="number" id="year" class="border-b border-black w-24 text-center" readonly>
                    </div>
                </div>

                <!-- Course and Instructor Details -->
                <div class="space-y-4 mb-8">
                    <div>
                        <label>Course Name:</label>
                        <input type="text" id="course-name" class="border-b border-black w-full" readonly>
                    </div>
                    <div>
                        <label>Instructor's Name:</label>
                        <input type="text" id="instructor-name" class="border-b border-black w-full" readonly>
                    </div>
                </div>

                <!-- Prerequisites Assessment Table -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-4">Outcome Assessment</h3>
                    <p class="mb-4">Assessment of the students preparedness for this course at the start of this term
                    </p>
                    <table id="prerequisites-table" class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border p-2 w-1/2">At the beginning of this term:</th>
                                <th class="border p-2">Nearly 100%</th>
                                <th class="border p-2">Nearly 75%</th>
                                <th class="border p-2">Nearly 50%</th>
                                <th class="border p-2">Nearly 25%</th>
                                <th class="border p-2">N/A</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border p-2">1. Students had the prerequisite math skills.</td>
                                <td class="border p-2 text-center"><input type="checkbox" name="math" value="100"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="math" value="75"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="math" value="50"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="math" value="25"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="math" value="na"></td>
                            </tr>
                            <tr>
                                <td class="border p-2">2. Students had the prerequisite laboratory skills.</td>
                                <td class="border p-2 text-center"><input type="checkbox" name="lab" value="100"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="lab" value="75"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="lab" value="50"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="lab" value="25"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="lab" value="na"></td>
                            </tr>
                            <tr>
                                <td class="border p-2">3. Students had the prerequisite problem solving skills</td>
                                <td class="border p-2 text-center"><input type="checkbox" name="problem-solving"
                                        value="100"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="problem-solving"
                                        value="75"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="problem-solving"
                                        value="50"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="problem-solving"
                                        value="25"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="problem-solving"
                                        value="na"></td>
                            </tr>
                            <tr>
                                <td class="border p-2">4. Students had the prerequisite design skills</td>
                                <td class="border p-2 text-center"><input type="checkbox" name="design" value="100">
                                </td>
                                <td class="border p-2 text-center"><input type="checkbox" name="design" value="75"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="design" value="50"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="design" value="25"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="design" value="na"></td>
                            </tr>
                            <tr>
                                <td class="border p-2">5. Students were capable of using the necessary Tools (e.g.
                                    hardware/software, etc.)</td>
                                <td class="border p-2 text-center"><input type="checkbox" name="tools" value="100"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="tools" value="75"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="tools" value="50"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="tools" value="25"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="tools" value="na"></td>
                            </tr>
                            <tr>
                                <td class="border p-2">6. Students had the necessary Programming skills</td>
                                <td class="border p-2 text-center"><input type="checkbox" name="programming"
                                        value="100"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="programming" value="75">
                                </td>
                                <td class="border p-2 text-center"><input type="checkbox" name="programming" value="50">
                                </td>
                                <td class="border p-2 text-center"><input type="checkbox" name="programming" value="25">
                                </td>
                                <td class="border p-2 text-center"><input type="checkbox" name="programming" value="na">
                                </td>
                            </tr>
                            <tr>
                                <td class="border p-2">7. Students had the necessary communication skills.</td>
                                <td class="border p-2 text-center"><input type="checkbox" name="communication"
                                        value="100"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="communication"
                                        value="75"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="communication"
                                        value="50"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="communication"
                                        value="25"></td>
                                <td class="border p-2 text-center"><input type="checkbox" name="communication"
                                        value="na"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Course Outcomes Table -->
                <div class="mb-8">
                    <table id="outcomes-table" class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border p-2 w-2/5">Course Learning Outcomes (assessed within course)</th>
                                <th class="border p-2 w-1/5">How/Where Assessed</th>
                                <th class="border p-2">Min Pass %</th>
                                <th class="border p-2">High Score %</th>
                                <th class="border p-2">Class Avg %</th>
                                <th class="border p-2">Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border p-2">To understand the difference between traditional systems and
                                    database systems.</td>
                                <td class="border p-2">Assignment 1/ Assignment 2/ Quiz 1/Quiz 2</td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="20"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="100"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="80"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="text" value="A+" class="w-full text-center"></td>
                            </tr>
                            <tr>
                                <td class="border p-2">How to gather requirements for database applications and
                                    different elicitation techniques.</td>
                                <td class="border p-2">Assignment 3/Final</td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="40"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="100"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="80"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="text" value="A-" class="w-full text-center"></td>
                            </tr>
                            <tr>
                                <td class="border p-2">To analyze different UML techniques.</td>
                                <td class="border p-2">Quiz 3 / Quiz 4/Final</td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="0"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="100"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="70"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="text" value="A+" class="w-full text-center"></td>
                            </tr>
                            <tr>
                                <td class="border p-2">To apply conceptual model techniques on gathered requirements.
                                </td>
                                <td class="border p-2">Assignment 3/ Assignment 4 / Final</td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="10"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="100"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="number" min="0" max="100" value="100"
                                        class="w-full text-center"></td>
                                <td class="border p-2"><input type="text" value="A+" class="w-full text-center"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="note ml-12 mt-4 italic text-gray-600">
                        Note: For Grade give the class average on an "A=4.0, B=3.0" basis.
                    </div>

                    <!-- Recommendations Section -->
                    <div class="recommendations ml-12 mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <h3 class="text-xl font-bold mb-2">Recommendations:</h3>
                        <p>Include which outcomes require more attention within the course to improve student
                            performance, and how the course should be altered in the future to improve results.</p>
                        <textarea id="recommendations" class="w-full mt-2 p-2 border rounded" rows="4"></textarea>
                    </div>

                    <!-- Buttons with Original Styling -->
                    <div class="ml-12 mt-16 mb-16 space-x-4">
                        <button type="submit" id="submit-btn"
                            class="bg-black text-white font-bold py-4 px-8 rounded-xl hover:bg-purple-600 transition-all duration-100 active:scale-95 active:bg-purple-600">
                            Submit
                        </button>
                        <button type="button" id="print-btn"
                            class="bg-black text-white font-bold py-4 px-8 rounded-xl hover:bg-purple-600 transition-all duration-100 active:scale-95 active:bg-purple-600">
                            Print
                        </button>

                    </div>
            </form>
        </div>
    </div>

    <script>
        // Token validation and role check
        const token = localStorage.getItem('token');
        if (token) {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const isExpired = payload.exp * 1000 < Date.now();
            const role = payload.role || "";

            if (role === 'teacher') {
                document.getElementById('manage-login-btn').style.display = 'none';
            }

            if (isExpired) {
                alert('Session expired. Please log in again.');
                localStorage.removeItem('token');
                window.location.href = '../../../login/login.html';
            } else {
                fetch('http://localhost:5000/api/auth/validate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`,
                    },
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error('Invalid token. Please log in again.');
                        }
                        return response.json();
                    })
                    .then((data) => {
                        console.log('Token is valid:', data);
                        document.body.style.display = 'block';
                    })
                    .catch((err) => {
                        alert(err.message);
                        localStorage.removeItem('token');
                        window.location.href = '../../login/login.html';
                    });
            }
        } else {
            alert('Access denied. Please log in.');
            window.location.href = '../../login/login.html';
        }

        // Populate form fields from localStorage
        document.addEventListener("DOMContentLoaded", async () => {


            document.getElementById("print-btn").addEventListener("click", handlePrint)
            const course = document.getElementById("course-name");
            const instructor = document.getElementById("instructor-name");
            const batch = document.getElementById("batch");
            const year = document.getElementById("year");

            const courseValue = localStorage.getItem("course");
            const instructorValue = localStorage.getItem("teacher");
            const session = localStorage.getItem("session");
            const className = localStorage.getItem("class");

            const yearValue = session.split(" ")[0];
            const batchValue = session.split(" ")[1];

            course.value = courseValue.toUpperCase();
            instructor.value = instructorValue.toUpperCase();
            batch.value = batchValue.toUpperCase();
            year.value = yearValue.toUpperCase();



            // Function to fetch existing data
            async function fetchAndPopulateData() {
                try {
                    const response = await fetch(`http://localhost:5000/api/teacher/course/outcome-assessment?batch=${batchValue}&year=${yearValue}&courseName=${courseValue}&instructorName=${instructorValue}&className=${className}`);

                    if (!response.ok) {
                        console.log(response);
                        throw new Error("No existing data found.");
                    }

                    const existingData = await response.json();
                    console.log(existingData);

                    // Populate prerequisites
                    existingData.prerequisites.forEach((item) => {
                        document.querySelectorAll('#prerequisites-table tbody tr').forEach(row => {
                            const question = row.querySelector('td').textContent.trim();
                            if (question === item.question) {
                                const checkboxes = row.querySelectorAll('input[type="checkbox"]');
                                checkboxes.forEach(checkbox => {
                                    checkbox.checked = checkbox.value === item.value;
                                });
                            }
                        });
                    });

                    // Populate outcomes
                    existingData.outcomes.forEach((item, index) => {
                        const row = document.querySelectorAll('#outcomes-table tbody tr')[index];
                        if (row) {
                            row.querySelectorAll('td')[1].textContent = item.howAssessed;
                            row.querySelectorAll('td')[2].querySelector('input').value = item.minPass;
                            row.querySelectorAll('td')[3].querySelector('input').value = item.highScore;
                            row.querySelectorAll('td')[4].querySelector('input').value = item.classAvg;
                            row.querySelectorAll('td')[5].querySelector('input').value = item.grade;
                        }
                    });

                    return true;

                } catch (error) {
                    console.log("No existing data found. Proceeding with new submission.");
                    return false;
                }
            }

            // Fetch existing data on page load
            const dataExists = await fetchAndPopulateData();

            // Exclusive checkbox selection for each row
            document.querySelectorAll('#prerequisites-table tbody tr').forEach(row => {
                const checkboxes = row.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function () {
                        if (this.checked) {
                            checkboxes.forEach(cb => {
                                if (cb !== this) cb.checked = false;
                            });
                        }
                    });
                });
            });

            // Form submission handler
            document.getElementById('outcomes-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                // // If data exists, prevent re-submission
                // if (dataExists) {
                //     alert("Data already exists. No need to submit.");
                //     return;
                // }

                // Collect form data
                const formData = {
                    batch: document.getElementById('batch').value,
                    year: document.getElementById('year').value,
                    courseName: localStorage.getItem("course"),
                    instructorName: localStorage.getItem("teacher"),
                    className: localStorage.getItem("class"),
                    prerequisites: [],
                    outcomes: [],
                };

                // Collect prerequisites data
                document.querySelectorAll('#prerequisites-table tbody tr').forEach(row => {
                    const question = row.querySelector('td').textContent.trim();
                    const selectedValue = row.querySelector('input[type="checkbox"]:checked')?.value || 'N/A';
                    formData.prerequisites.push({ question, value: selectedValue });
                });

                // Collect outcomes data
                document.querySelectorAll('#outcomes-table tbody tr').forEach(row => {
                    const outcome = row.querySelector('td').textContent.trim();
                    const howAssessed = row.querySelectorAll('td')[1].textContent.trim();
                    const minPass = row.querySelectorAll('td')[2].querySelector('input').value;
                    const highScore = row.querySelectorAll('td')[3].querySelector('input').value;
                    const classAvg = row.querySelectorAll('td')[4].querySelector('input').value;
                    const grade = row.querySelectorAll('td')[5].querySelector('input').value;
                    formData.outcomes.push({ outcome, howAssessed, minPass, highScore, classAvg, grade });
                });

                // Send data to the API
                try {
                    const response = await fetch('http://localhost:5000/api/teacher/course/outcome-assessment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData),
                    });

                    if (!response.ok) {
                        throw new Error('Failed to submit form data.');
                    }

                    const result = await response.json();
                    console.log('Form submitted successfully:', result);
                    alert('Form submitted successfully!');
                } catch (error) {
                    console.error('Error submitting form:', error);
                    alert('Error submitting form. Please try again.');
                }
            });
        });
        function handlePrint() {
            // Hide elements before printing
            document.getElementById("sidebar").style.display = "none";
            document.getElementById("print-btn").style.display = "none";
            document.getElementById("submit-btn").style.display = "none";

            // Trigger the print dialog
            window.print();

            // Restore the sidebar after printing (for both print and cancel actions)
            window.onafterprint = () => {
                document.getElementById("sidebar").style.display = "block";
                document.getElementById("print-btn").style.display = "block";
                document.getElementById("submit-btn").style.display = "block";
            };

            // In case of print cancellation (for browsers that don't trigger onafterprint on cancel)
            window.onbeforeprint = () => {
                document.getElementById("sidebar").style.display = "block";
                document.getElementById("print-btn").style.display = "block";
                document.getElementById("submit-btn").style.display = "block";
            };
        }


    </script>
</body>

</html>